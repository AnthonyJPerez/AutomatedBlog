{% extends "base.html" %}

{% block title %}Competitor Analysis Dashboard{% endblock %}

{% block content %}
<div class="container my-4">
    <h1 class="mb-4">Competitor Analysis Dashboard</h1>
    
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Competitor Tracking</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <div>
                            <select id="blogSelector" class="form-select">
                                <option value="">All Blogs</option>
                                {% for blog in blogs %}
                                <option value="{{ blog.id }}">{{ blog.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCompetitorModal">
                            <i class="bi bi-plus"></i> Add Competitor
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="competitorsTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>URL</th>
                                    <th>Blog</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" class="text-center">Loading competitors...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Analysis Overview</h5>
                </div>
                <div class="card-body">
                    <div id="analysisStats">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Total Competitors:</span>
                            <span id="totalCompetitors" class="fw-bold">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Analyzed Articles:</span>
                            <span id="analyzedArticles" class="fw-bold">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Keywords Extracted:</span>
                            <span id="keywordsExtracted" class="fw-bold">0</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Last Analysis:</span>
                            <span id="lastAnalysis" class="fw-bold">Never</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button id="runGapAnalysisBtn" class="btn btn-outline-primary" disabled>
                            <i class="bi bi-bar-chart"></i> Run Gap Analysis
                        </button>
                        <button id="getRecommendationsBtn" class="btn btn-outline-success" disabled>
                            <i class="bi bi-lightbulb"></i> Get Content Recommendations
                        </button>
                        <button id="generateReportBtn" class="btn btn-outline-info" disabled>
                            <i class="bi bi-file-earmark-text"></i> Generate Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Competitor Insights</h5>
                    <div>
                        <select id="competitorSelector" class="form-select">
                            <option value="">Select a competitor</option>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <div id="competitorInsights" class="row">
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">Top Keywords</h6>
                                </div>
                                <div class="card-body">
                                    <div id="topKeywords">
                                        <p class="text-muted text-center">Select a competitor to view keywords</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">Content Structure</h6>
                                </div>
                                <div class="card-body">
                                    <div id="contentStructure">
                                        <p class="text-muted text-center">Select a competitor to view content structure</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">SEO Metrics</h6>
                                </div>
                                <div class="card-body">
                                    <div id="seoMetrics">
                                        <p class="text-muted text-center">Select a competitor to view SEO metrics</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Content Gap Analysis</h5>
                </div>
                <div class="card-body">
                    <div id="gapAnalysisResults">
                        <p class="text-muted text-center">Run a gap analysis to view results</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Content Recommendations</h5>
                </div>
                <div class="card-body">
                    <div id="contentRecommendations">
                        <p class="text-muted text-center">Get recommendations to view results</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Competitor Modal -->
<div class="modal fade" id="addCompetitorModal" tabindex="-1" aria-labelledby="addCompetitorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCompetitorModalLabel">Add Competitor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addCompetitorForm">
                    <div class="mb-3">
                        <label for="competitorUrl" class="form-label">Website URL *</label>
                        <input type="url" class="form-control" id="competitorUrl" required placeholder="https://example.com">
                    </div>
                    <div class="mb-3">
                        <label for="competitorName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="competitorName" placeholder="Optional, will be extracted from the website">
                    </div>
                    <div class="mb-3">
                        <label for="competitorDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="competitorDescription" rows="2" placeholder="Optional description"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="competitorCategory" class="form-label">Category</label>
                        <input type="text" class="form-control" id="competitorCategory" placeholder="e.g., Technology, Finance, Health">
                    </div>
                    <div class="mb-3">
                        <label for="competitorBlogId" class="form-label">Associated Blog</label>
                        <select class="form-select" id="competitorBlogId">
                            <option value="">None (Global Competitor)</option>
                            {% for blog in blogs %}
                            <option value="{{ blog.id }}">{{ blog.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="competitorPriority" class="form-label">Priority</label>
                        <select class="form-select" id="competitorPriority">
                            <option value="1">High</option>
                            <option value="2">Medium</option>
                            <option value="3">Low</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveCompetitorBtn">Add Competitor</button>
            </div>
        </div>
    </div>
</div>

<!-- Competitor Details Modal -->
<div class="modal fade" id="competitorDetailsModal" tabindex="-1" aria-labelledby="competitorDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="competitorDetailsModalLabel">Competitor Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="competitorDetails">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading competitor details...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="analyzeCompetitorBtn">Analyze Content</button>
            </div>
        </div>
    </div>
</div>

<!-- Analysis Results Modal -->
<div class="modal fade" id="analysisResultsModal" tabindex="-1" aria-labelledby="analysisResultsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="analysisResultsModalLabel">Analysis Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="analysisResults">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Analysis in progress...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="downloadAnalysisBtn">Download Report</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initial data loading
    loadCompetitors();
    
    // Event listeners
    document.getElementById('blogSelector').addEventListener('change', loadCompetitors);
    document.getElementById('saveCompetitorBtn').addEventListener('click', addCompetitor);
    document.getElementById('competitorSelector').addEventListener('change', loadCompetitorInsights);
    document.getElementById('runGapAnalysisBtn').addEventListener('click', runGapAnalysis);
    document.getElementById('getRecommendationsBtn').addEventListener('click', getContentRecommendations);
    document.getElementById('generateReportBtn').addEventListener('click', generateReport);
    document.getElementById('analyzeCompetitorBtn').addEventListener('click', analyzeSelectedCompetitor);
    document.getElementById('downloadAnalysisBtn').addEventListener('click', downloadAnalysisReport);
    
    // Functions
    function loadCompetitors() {
        const blogId = document.getElementById('blogSelector').value;
        const url = blogId ? `/api/competitors?blog_id=${blogId}` : '/api/competitors';
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderCompetitors(data.competitors);
                    updateAnalysisStats(data.competitors);
                    updateCompetitorSelector(data.competitors);
                    
                    // Enable buttons if blog is selected
                    const buttonsEnabled = blogId !== '';
                    document.getElementById('runGapAnalysisBtn').disabled = !buttonsEnabled;
                    document.getElementById('getRecommendationsBtn').disabled = !buttonsEnabled;
                    document.getElementById('generateReportBtn').disabled = !buttonsEnabled;
                } else {
                    showError('Error loading competitors: ' + data.message);
                }
            })
            .catch(error => {
                showError('Error loading competitors: ' + error.message);
            });
    }
    
    function renderCompetitors(competitors) {
        const tbody = document.querySelector('#competitorsTable tbody');
        
        if (competitors.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">No competitors found. Add your first competitor.</td></tr>';
            return;
        }
        
        tbody.innerHTML = '';
        
        competitors.forEach(competitor => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${competitor.name || 'Unnamed'}</td>
                <td><a href="${competitor.url}" target="_blank">${formatUrl(competitor.url)}</a></td>
                <td>${competitor.blog_name || 'Global'}</td>
                <td>${competitor.category || 'General'}</td>
                <td>${getStatusBadge(competitor.status)}</td>
                <td>
                    <button class="btn btn-sm btn-outline-info view-btn" data-id="${competitor.id}">
                        <i class="bi bi-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${competitor.id}">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
            
            // Add event listeners
            tr.querySelector('.view-btn').addEventListener('click', () => viewCompetitor(competitor.id));
            tr.querySelector('.delete-btn').addEventListener('click', () => deleteCompetitor(competitor.id));
        });
    }
    
    function formatUrl(url) {
        if (!url) return '';
        
        // Remove protocol
        let formatted = url.replace(/^https?:\/\//, '');
        
        // Truncate if too long
        if (formatted.length > 30) {
            formatted = formatted.substring(0, 27) + '...';
        }
        
        return formatted;
    }
    
    function getStatusBadge(status) {
        if (!status) {
            return '<span class="badge bg-secondary">New</span>';
        }
        
        switch (status.toLowerCase()) {
            case 'analyzed':
                return '<span class="badge bg-success">Analyzed</span>';
            case 'error':
                return '<span class="badge bg-danger">Error</span>';
            case 'analyzing':
                return '<span class="badge bg-warning">Analyzing</span>';
            default:
                return '<span class="badge bg-secondary">Pending</span>';
        }
    }
    
    function updateAnalysisStats(competitors) {
        document.getElementById('totalCompetitors').textContent = competitors.length;
        
        let analyzedCount = 0;
        let keywordsCount = 0;
        let lastAnalysisDate = null;
        
        competitors.forEach(competitor => {
            if (competitor.status === 'analyzed') {
                analyzedCount++;
                
                if (competitor.keywords_count) {
                    keywordsCount += competitor.keywords_count;
                }
                
                if (competitor.last_analyzed) {
                    const analysisDate = new Date(competitor.last_analyzed);
                    if (!lastAnalysisDate || analysisDate > lastAnalysisDate) {
                        lastAnalysisDate = analysisDate;
                    }
                }
            }
        });
        
        document.getElementById('analyzedArticles').textContent = analyzedCount;
        document.getElementById('keywordsExtracted').textContent = keywordsCount;
        
        if (lastAnalysisDate) {
            document.getElementById('lastAnalysis').textContent = lastAnalysisDate.toLocaleDateString();
        } else {
            document.getElementById('lastAnalysis').textContent = 'Never';
        }
    }
    
    function updateCompetitorSelector(competitors) {
        const selector = document.getElementById('competitorSelector');
        
        // Clear current options
        selector.innerHTML = '<option value="">Select a competitor</option>';
        
        // Add options for each competitor
        competitors.forEach(competitor => {
            const option = document.createElement('option');
            option.value = competitor.id;
            option.textContent = competitor.name || formatUrl(competitor.url);
            selector.appendChild(option);
        });
    }
    
    function addCompetitor() {
        const url = document.getElementById('competitorUrl').value;
        if (!url) {
            showError('URL is required');
            return;
        }
        
        const competitorData = {
            url: url,
            name: document.getElementById('competitorName').value,
            description: document.getElementById('competitorDescription').value,
            category: document.getElementById('competitorCategory').value,
            blog_id: document.getElementById('competitorBlogId').value,
            priority: document.getElementById('competitorPriority').value
        };
        
        fetch('/api/competitors', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(competitorData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal and reload competitors
                $('#addCompetitorModal').modal('hide');
                loadCompetitors();
                
                // Reset form
                document.getElementById('addCompetitorForm').reset();
                
                showSuccess('Competitor added successfully');
            } else {
                showError('Error adding competitor: ' + data.message);
            }
        })
        .catch(error => {
            showError('Error adding competitor: ' + error.message);
        });
    }
    
    function viewCompetitor(competitorId) {
        // Show the details modal
        const modal = new bootstrap.Modal(document.getElementById('competitorDetailsModal'));
        modal.show();
        
        // Set the analyze button competitor ID
        document.getElementById('analyzeCompetitorBtn').setAttribute('data-id', competitorId);
        
        // Load competitor details
        fetch(`/api/competitors/${competitorId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderCompetitorDetails(data);
                } else {
                    document.getElementById('competitorDetails').innerHTML = `
                        <div class="alert alert-danger">
                            ${data.message || 'Error loading competitor details'}
                        </div>
                    `;
                }
            })
            .catch(error => {
                document.getElementById('competitorDetails').innerHTML = `
                    <div class="alert alert-danger">
                        ${error.message}
                    </div>
                `;
            });
    }
    
    function renderCompetitorDetails(data) {
        const competitor = data.competitor;
        const details = document.getElementById('competitorDetails');
        
        let html = `
            <div class="mb-4">
                <h4>${competitor.name || 'Unnamed Competitor'}</h4>
                <p class="text-muted">
                    <a href="${competitor.url}" target="_blank">${competitor.url}</a>
                </p>
                ${competitor.description ? `<p>${competitor.description}</p>` : ''}
            </div>
        `;
        
        // Add analysis data if available
        if (competitor.status === 'analyzed' && data.analysis) {
            const analysis = data.analysis;
            
            html += `
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="card-title mb-0">Content Summary</h6>
                            </div>
                            <div class="card-body">
                                <dl class="row">
                                    <dt class="col-sm-6">Total Articles Analyzed</dt>
                                    <dd class="col-sm-6">${analysis.articles_count || 0}</dd>
                                    
                                    <dt class="col-sm-6">Average Word Count</dt>
                                    <dd class="col-sm-6">${analysis.average_word_count || 'N/A'}</dd>
                                    
                                    <dt class="col-sm-6">Readability Score</dt>
                                    <dd class="col-sm-6">${analysis.readability_score || 'N/A'}</dd>
                                    
                                    <dt class="col-sm-6">Primary Topics</dt>
                                    <dd class="col-sm-6">${formatArrayToList(analysis.primary_topics)}</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="card-title mb-0">SEO Analysis</h6>
                            </div>
                            <div class="card-body">
                                <dl class="row">
                                    <dt class="col-sm-6">Keywords Found</dt>
                                    <dd class="col-sm-6">${analysis.keywords_count || 0}</dd>
                                    
                                    <dt class="col-sm-6">Average Title Length</dt>
                                    <dd class="col-sm-6">${analysis.average_title_length || 'N/A'}</dd>
                                    
                                    <dt class="col-sm-6">Average Meta Description</dt>
                                    <dd class="col-sm-6">${analysis.average_meta_length || 'N/A'}</dd>
                                    
                                    <dt class="col-sm-6">Top Keywords</dt>
                                    <dd class="col-sm-6">${formatKeywords(analysis.top_keywords)}</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header">
                        <h6 class="card-title mb-0">Recent Articles</h6>
                    </div>
                    <div class="card-body">
                        <div class="list-group">
                            ${renderArticlesList(analysis.articles)}
                        </div>
                    </div>
                </div>
            `;
        } else {
            html += `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    This competitor has not been analyzed yet. Click "Analyze Content" to extract content insights.
                </div>
            `;
        }
        
        details.innerHTML = html;
    }
    
    function formatArrayToList(array) {
        if (!array || !array.length) return 'None';
        return array.slice(0, 3).join(', ');
    }
    
    function formatKeywords(keywords) {
        if (!keywords || !Object.keys(keywords).length) return 'None';
        
        const formattedKeywords = [];
        for (const [keyword, count] of Object.entries(keywords)) {
            formattedKeywords.push(`${keyword} (${count})`);
            if (formattedKeywords.length >= 3) break;
        }
        
        return formattedKeywords.join(', ');
    }
    
    function renderArticlesList(articles) {
        if (!articles || !articles.length) {
            return '<p class="text-muted">No articles analyzed</p>';
        }
        
        let html = '';
        articles.slice(0, 5).forEach(article => {
            html += `
                <a href="${article.url}" target="_blank" class="list-group-item list-group-item-action">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${article.title}</h6>
                        ${article.date ? `<small>${new Date(article.date).toLocaleDateString()}</small>` : ''}
                    </div>
                    <p class="mb-1 text-muted small">${article.summary || 'No summary available'}</p>
                </a>
            `;
        });
        
        return html;
    }
    
    function deleteCompetitor(competitorId) {
        if (!confirm('Are you sure you want to delete this competitor? This action cannot be undone.')) {
            return;
        }
        
        fetch(`/api/competitors/${competitorId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadCompetitors();
                showSuccess('Competitor deleted successfully');
            } else {
                showError('Error deleting competitor: ' + data.message);
            }
        })
        .catch(error => {
            showError('Error deleting competitor: ' + error.message);
        });
    }
    
    function analyzeSelectedCompetitor() {
        const competitorId = document.getElementById('analyzeCompetitorBtn').getAttribute('data-id');
        if (!competitorId) return;
        
        // Show the analysis results modal
        const modal = new bootstrap.Modal(document.getElementById('analysisResultsModal'));
        modal.show();
        
        // Set loading state
        document.getElementById('analysisResults').innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Analysis in progress. This may take a minute...</p>
            </div>
        `;
        
        // Make API call to analyze
        fetch(`/api/competitors/${competitorId}/analyze`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ max_articles: 10 })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderAnalysisResults(data);
            } else {
                document.getElementById('analysisResults').innerHTML = `
                    <div class="alert alert-danger">
                        ${data.message || 'Error analyzing competitor'}
                    </div>
                `;
            }
        })
        .catch(error => {
            document.getElementById('analysisResults').innerHTML = `
                <div class="alert alert-danger">
                    ${error.message}
                </div>
            `;
        });
    }
    
    function renderAnalysisResults(data) {
        const analysis = data.analysis;
        const resultsContainer = document.getElementById('analysisResults');
        
        let html = `
            <h4 class="mb-3">Analysis Results for ${analysis.competitor_name || 'Competitor'}</h4>
            
            <div class="alert alert-success">
                <i class="bi bi-check-circle me-2"></i>
                Analysis completed successfully. ${analysis.articles_analyzed || 0} articles were analyzed.
            </div>
            
            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="card-title mb-0">Content Insights</h6>
                        </div>
                        <div class="card-body">
                            <dl class="row">
                                <dt class="col-sm-6">Content Type</dt>
                                <dd class="col-sm-6">${analysis.content_type || 'Mixed'}</dd>
                                
                                <dt class="col-sm-6">Average Word Count</dt>
                                <dd class="col-sm-6">${analysis.average_word_count || 'N/A'}</dd>
                                
                                <dt class="col-sm-6">Content Structure</dt>
                                <dd class="col-sm-6">${analysis.content_structure || 'Varied'}</dd>
                                
                                <dt class="col-sm-6">Primary Topics</dt>
                                <dd class="col-sm-6">${formatArrayToList(analysis.primary_topics)}</dd>
                            </dl>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="card-title mb-0">Keyword Analysis</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <h6>Top Keywords</h6>
                                <div class="d-flex flex-wrap gap-2">
                                    ${renderKeywordBadges(analysis.top_keywords)}
                                </div>
                            </div>
                            <div>
                                <h6>Related Terms</h6>
                                <div class="d-flex flex-wrap gap-2">
                                    ${renderKeywordBadges(analysis.related_terms)}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">Articles Analyzed</h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>Word Count</th>
                                            <th>Keywords</th>
                                            <th>Published</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${renderArticlesTable(analysis.articles)}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        resultsContainer.innerHTML = html;
        
        // Update stats and reload competitors with new data
        loadCompetitors();
    }
    
    function renderKeywordBadges(keywords) {
        if (!keywords || Object.keys(keywords).length === 0) {
            return '<span class="text-muted">No keywords found</span>';
        }
        
        let html = '';
        for (const [keyword, count] of Object.entries(keywords)) {
            html += `<span class="badge bg-primary">${keyword} (${count})</span>`;
        }
        
        return html;
    }
    
    function renderArticlesTable(articles) {
        if (!articles || articles.length === 0) {
            return '<tr><td colspan="4" class="text-center">No articles analyzed</td></tr>';
        }
        
        let html = '';
        articles.forEach(article => {
            html += `
                <tr>
                    <td>
                        <a href="${article.url}" target="_blank" class="text-decoration-none">
                            ${article.title}
                        </a>
                    </td>
                    <td>${article.word_count || 'N/A'}</td>
                    <td>${article.keywords ? article.keywords.slice(0, 3).join(', ') : 'N/A'}</td>
                    <td>${article.date ? new Date(article.date).toLocaleDateString() : 'Unknown'}</td>
                </tr>
            `;
        });
        
        return html;
    }
    
    function loadCompetitorInsights() {
        const competitorId = document.getElementById('competitorSelector').value;
        if (!competitorId) {
            resetInsightPanels();
            return;
        }
        
        fetch(`/api/competitors/${competitorId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.analysis) {
                    renderCompetitorInsights(data.analysis);
                } else {
                    resetInsightPanels('No analysis data available');
                }
            })
            .catch(error => {
                resetInsightPanels('Error loading insights');
            });
    }
    
    function renderCompetitorInsights(analysis) {
        // Top Keywords
        const keywordsHtml = renderKeywordsInsight(analysis.top_keywords);
        document.getElementById('topKeywords').innerHTML = keywordsHtml;
        
        // Content Structure
        const structureHtml = renderContentStructureInsight(analysis);
        document.getElementById('contentStructure').innerHTML = structureHtml;
        
        // SEO Metrics
        const seoHtml = renderSeoMetricsInsight(analysis);
        document.getElementById('seoMetrics').innerHTML = seoHtml;
    }
    
    function renderKeywordsInsight(keywords) {
        if (!keywords || Object.keys(keywords).length === 0) {
            return '<p class="text-muted text-center">No keywords found</p>';
        }
        
        let html = '<ul class="list-group">';
        
        // Sort keywords by count
        const sortedKeywords = Object.entries(keywords)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10);
            
        sortedKeywords.forEach(([keyword, count]) => {
            html += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    ${keyword}
                    <span class="badge bg-primary rounded-pill">${count}</span>
                </li>
            `;
        });
        
        html += '</ul>';
        return html;
    }
    
    function renderContentStructureInsight(analysis) {
        const articles = analysis.articles;
        if (!articles || articles.length === 0) {
            return '<p class="text-muted text-center">No content structure data available</p>';
        }
        
        let html = '<div class="accordion" id="contentStructureAccordion">';
        
        // Show structure for up to 3 articles
        for (let i = 0; i < Math.min(3, articles.length); i++) {
            const article = articles[i];
            if (!article.title) continue;
            
            html += `
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading${i}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                data-bs-target="#collapse${i}" aria-expanded="false" aria-controls="collapse${i}">
                            ${truncateText(article.title, 40)}
                        </button>
                    </h2>
                    <div id="collapse${i}" class="accordion-collapse collapse" 
                         aria-labelledby="heading${i}" data-bs-parent="#contentStructureAccordion">
                        <div class="accordion-body">
                            ${renderArticleStructure(article)}
                        </div>
                    </div>
                </div>
            `;
        }
        
        html += '</div>';
        return html;
    }
    
    function renderArticleStructure(article) {
        if (!article.headings || article.headings.length === 0) {
            return '<p class="text-muted">No structure information available</p>';
        }
        
        let html = '<ul class="list-group">';
        
        article.headings.forEach(heading => {
            const level = heading.level || 1;
            const marginLeft = (level - 1) * 1.5;
            
            html += `
                <li class="list-group-item" style="margin-left: ${marginLeft}rem;">
                    <span class="badge bg-secondary me-2">H${level}</span>
                    ${heading.text}
                </li>
            `;
        });
        
        html += '</ul>';
        return html;
    }
    
    function renderSeoMetricsInsight(analysis) {
        let html = '<div class="list-group">';
        
        // Average word count
        const wordCount = analysis.average_word_count || 'N/A';
        html += `
            <div class="list-group-item">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">Average Word Count</h6>
                    <span>${wordCount}</span>
                </div>
                <p class="mb-1 text-muted small">Typical article length</p>
            </div>
        `;
        
        // Readability
        const readability = analysis.readability_score || 'N/A';
        html += `
            <div class="list-group-item">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">Readability Score</h6>
                    <span>${readability}</span>
                </div>
                <p class="mb-1 text-muted small">Flesh-Kincaid reading level</p>
            </div>
        `;
        
        // Average title length
        const titleLength = analysis.average_title_length || 'N/A';
        html += `
            <div class="list-group-item">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">Average Title Length</h6>
                    <span>${titleLength} chars</span>
                </div>
                <p class="mb-1 text-muted small">Title optimization</p>
            </div>
        `;
        
        // Update frequency
        const frequency = analysis.update_frequency || 'N/A';
        html += `
            <div class="list-group-item">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">Content Frequency</h6>
                    <span>${frequency}</span>
                </div>
                <p class="mb-1 text-muted small">Publishing cadence</p>
            </div>
        `;
        
        html += '</div>';
        return html;
    }
    
    function truncateText(text, maxLength) {
        if (!text) return '';
        return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }
    
    function resetInsightPanels(message = 'Select a competitor to view data') {
        document.getElementById('topKeywords').innerHTML = `<p class="text-muted text-center">${message}</p>`;
        document.getElementById('contentStructure').innerHTML = `<p class="text-muted text-center">${message}</p>`;
        document.getElementById('seoMetrics').innerHTML = `<p class="text-muted text-center">${message}</p>`;
    }
    
    function runGapAnalysis() {
        const blogId = document.getElementById('blogSelector').value;
        if (!blogId) {
            showError('Please select a blog to run gap analysis');
            return;
        }
        
        document.getElementById('gapAnalysisResults').innerHTML = `
            <div class="text-center py-3">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Running gap analysis...</p>
            </div>
        `;
        
        fetch(`/api/blogs/${blogId}/competitive-gap-analysis`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderGapAnalysis(data);
                } else {
                    document.getElementById('gapAnalysisResults').innerHTML = `
                        <div class="alert alert-danger">
                            ${data.message || 'Error running gap analysis'}
                        </div>
                    `;
                }
            })
            .catch(error => {
                document.getElementById('gapAnalysisResults').innerHTML = `
                    <div class="alert alert-danger">
                        ${error.message}
                    </div>
                `;
            });
    }
    
    function renderGapAnalysis(data) {
        const gapAnalysis = data.gap_analysis;
        let html = '';
        
        if (gapAnalysis.content_gaps && gapAnalysis.content_gaps.length > 0) {
            html += `
                <h6 class="mb-3">Content Gaps Found</h6>
                <div class="list-group mb-4">
            `;
            
            gapAnalysis.content_gaps.forEach(gap => {
                html += `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${gap.topic}</h6>
                            <span class="badge bg-primary">${gap.competitor_count || 1} competitors</span>
                        </div>
                        <p class="mb-1 text-muted small">${gap.description || 'Topic covered by competitors but not found in your content'}</p>
                    </div>
                `;
            });
            
            html += '</div>';
        } else {
            html += `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    No significant content gaps found. Your content appears to be covering similar topics to your competitors.
                </div>
            `;
        }
        
        // Add keyword gaps
        if (gapAnalysis.keyword_gaps && gapAnalysis.keyword_gaps.length > 0) {
            html += `
                <h6 class="mb-3">Keyword Opportunities</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>Keyword</th>
                                <th>Competitors Using</th>
                                <th>Opportunity</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            gapAnalysis.keyword_gaps.forEach(keyword => {
                html += `
                    <tr>
                        <td>${keyword.keyword}</td>
                        <td>${keyword.competitor_count || 1}</td>
                        <td>
                            <div class="progress" style="height: 10px;">
                                <div class="progress-bar ${getOpportunityClass(keyword.opportunity)}" 
                                     role="progressbar" style="width: ${keyword.opportunity * 100}%"
                                     aria-valuenow="${keyword.opportunity * 100}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        document.getElementById('gapAnalysisResults').innerHTML = html;
    }
    
    function getOpportunityClass(opportunity) {
        if (!opportunity) return 'bg-secondary';
        
        if (opportunity >= 0.8) return 'bg-success';
        if (opportunity >= 0.5) return 'bg-primary';
        if (opportunity >= 0.3) return 'bg-info';
        return 'bg-secondary';
    }
    
    function getContentRecommendations() {
        const blogId = document.getElementById('blogSelector').value;
        if (!blogId) {
            showError('Please select a blog to get content recommendations');
            return;
        }
        
        document.getElementById('contentRecommendations').innerHTML = `
            <div class="text-center py-3">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Generating recommendations...</p>
            </div>
        `;
        
        fetch(`/api/blogs/${blogId}/content-recommendations`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderContentRecommendations(data);
                } else {
                    document.getElementById('contentRecommendations').innerHTML = `
                        <div class="alert alert-danger">
                            ${data.message || 'Error generating recommendations'}
                        </div>
                    `;
                }
            })
            .catch(error => {
                document.getElementById('contentRecommendations').innerHTML = `
                    <div class="alert alert-danger">
                        ${error.message}
                    </div>
                `;
            });
    }
    
    function renderContentRecommendations(data) {
        const recommendations = data.recommendations;
        let html = '';
        
        if (recommendations.topic_recommendations && recommendations.topic_recommendations.length > 0) {
            html += `
                <h6 class="mb-3">Recommended Topics</h6>
                <div class="list-group mb-4">
            `;
            
            recommendations.topic_recommendations.forEach(topic => {
                html += `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${topic.title}</h6>
                            <small class="text-muted">${topic.competitor_count || 1} competitors</small>
                        </div>
                        <p class="mb-1">${topic.description || 'Based on competitor content analysis'}</p>
                        ${topic.keywords ? `<small class="text-muted">Keywords: ${topic.keywords.join(', ')}</small>` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
        }
        
        // Add format recommendations
        if (recommendations.format_recommendations) {
            const format = recommendations.format_recommendations;
            
            html += `
                <h6 class="mb-3">Content Format Recommendations</h6>
                <div class="card mb-4">
                    <div class="card-body">
                        <dl class="row mb-0">
                            <dt class="col-sm-4">Optimal Length</dt>
                            <dd class="col-sm-8">${format.optimal_length || 'N/A'} words</dd>
                            
                            <dt class="col-sm-4">Content Structure</dt>
                            <dd class="col-sm-8">${format.structure || 'N/A'}</dd>
                            
                            <dt class="col-sm-4">Readability Level</dt>
                            <dd class="col-sm-8">${format.readability || 'N/A'}</dd>
                            
                            <dt class="col-sm-4">Recommended Elements</dt>
                            <dd class="col-sm-8">${format.elements ? format.elements.join(', ') : 'N/A'}</dd>
                        </dl>
                    </div>
                </div>
            `;
        }
        
        // Add keyword recommendations
        if (recommendations.keyword_recommendations && recommendations.keyword_recommendations.length > 0) {
            html += `
                <h6 class="mb-3">Keyword Recommendations</h6>
                <div class="d-flex flex-wrap gap-2 mb-4">
            `;
            
            recommendations.keyword_recommendations.forEach(keyword => {
                html += `
                    <div class="badge bg-primary p-2">
                        ${keyword.keyword}
                        ${keyword.density ? `<span class="badge bg-light text-dark ms-1">${keyword.density}</span>` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
        }
        
        document.getElementById('contentRecommendations').innerHTML = html;
    }
    
    function generateReport() {
        const blogId = document.getElementById('blogSelector').value;
        if (!blogId) {
            showError('Please select a blog to generate a report');
            return;
        }
        
        // Set format to HTML for better visualization
        const url = `/api/blogs/${blogId}/competitor-report?format=html`;
        
        // Open in a new tab
        window.open(url, '_blank');
    }
    
    function downloadAnalysisReport() {
        // In a real implementation, this would generate and download a report
        showInfo('Report download functionality will be implemented in a future update');
    }
    
    // Helper functions for notifications
    function showSuccess(message) {
        // Implementation would depend on your UI framework
        showToast(message, 'success');
    }
    
    function showError(message) {
        showToast(message, 'danger');
    }
    
    function showInfo(message) {
        showToast(message, 'info');
    }
    
    function showToast(message, type) {
        // Simple alert for now
        alert(message);
    }
});
</script>
{% endblock %}
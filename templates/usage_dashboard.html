{% extends 'base.html' %}

{% block title %}Usage & Billing Dashboard{% endblock %}

{% block content %}
<div class="container py-4">
    <h1 class="mb-4">Usage & Billing Dashboard</h1>
    
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">Global API Usage</h5>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <h6 class="text-muted">OpenAI API</h6>
                        <div class="progress mb-2">
                            <div id="openai-usage-bar" class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span id="openai-usage-text">0 / 0 tokens</span>
                            <span id="openai-credits" class="badge bg-info">$0.00</span>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h6 class="text-muted">Image Generation (DALL-E)</h6>
                        <div class="progress mb-2">
                            <div id="image-usage-bar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span id="image-usage-text">0 / 0 images</span>
                            <span id="image-credits" class="badge bg-info">$0.00</span>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h6 class="text-muted">WordPress API</h6>
                        <div class="progress mb-2">
                            <div id="wordpress-usage-bar" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span id="wordpress-usage-text">0 / 0 requests</span>
                            <span id="wordpress-credits" class="badge bg-info">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">Content Generation Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h3 id="total-blogs">0</h3>
                                    <p class="text-muted mb-0">Active Blogs</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h3 id="total-content">0</h3>
                                    <p class="text-muted mb-0">Content Pieces</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h3 id="total-images">0</h3>
                                    <p class="text-muted mb-0">Images Generated</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h3 id="total-published">0</h3>
                                    <p class="text-muted mb-0">Published Posts</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Blog-Specific Usage</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="blog-usage-table">
                            <thead>
                                <tr>
                                    <th>Blog</th>
                                    <th>Theme</th>
                                    <th>Content Generated</th>
                                    <th>Images</th>
                                    <th>Published</th>
                                    <th>Last Generated</th>
                                    <th>Total Usage</th>
                                </tr>
                            </thead>
                            <tbody id="blog-usage-tbody">
                                <!-- Dynamically populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">OpenAI Credentials</h5>
                </div>
                <div class="card-body">
                    <form id="openai-credentials-form">
                        <div class="mb-3">
                            <label for="openai-api-key" class="form-label">OpenAI API Key</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="openai-api-key" placeholder="sk-...">
                                <button class="btn btn-outline-secondary toggle-password" type="button">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <div class="form-text">Used for content generation and image creation.</div>
                        </div>
                        <button type="submit" class="btn btn-primary">Update OpenAI Credentials</button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Social Media Credentials</h5>
                </div>
                <div class="card-body">
                    <form id="social-media-credentials-form">
                        <div class="mb-3">
                            <label for="twitter-api-key" class="form-label">Twitter API Key</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="twitter-api-key">
                                <button class="btn btn-outline-secondary toggle-password" type="button">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="linkedin-api-key" class="form-label">LinkedIn API Key</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="linkedin-api-key">
                                <button class="btn btn-outline-secondary toggle-password" type="button">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="facebook-api-key" class="form-label">Facebook API Key</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="facebook-api-key">
                                <button class="btn btn-outline-secondary toggle-password" type="button">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Update Social Media Credentials</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Load global usage data
        fetchGlobalUsage();
        
        // Toggle password visibility
        document.querySelectorAll('.toggle-password').forEach(button => {
            button.addEventListener('click', function() {
                const input = this.parentElement.querySelector('input');
                const icon = this.querySelector('i');
                
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.remove('bi-eye');
                    icon.classList.add('bi-eye-slash');
                } else {
                    input.type = 'password';
                    icon.classList.remove('bi-eye-slash');
                    icon.classList.add('bi-eye');
                }
            });
        });
        
        // OpenAI credentials form
        document.getElementById('openai-credentials-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const apiKey = document.getElementById('openai-api-key').value;
            
            fetch('/api/global/credentials', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    openai_api_key: apiKey
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('OpenAI credentials updated successfully');
                } else {
                    alert('Error updating OpenAI credentials: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating credentials');
            });
        });
        
        // Social media credentials form
        document.getElementById('social-media-credentials-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const twitterApiKey = document.getElementById('twitter-api-key').value;
            const linkedinApiKey = document.getElementById('linkedin-api-key').value;
            const facebookApiKey = document.getElementById('facebook-api-key').value;
            
            fetch('/api/global/social-media-credentials', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    twitter_api_key: twitterApiKey,
                    linkedin_api_key: linkedinApiKey,
                    facebook_api_key: facebookApiKey
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Social media credentials updated successfully');
                } else {
                    alert('Error updating social media credentials: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating credentials');
            });
        });
    });
    
    function fetchGlobalUsage() {
        fetch('/api/global/usage')
            .then(response => response.json())
            .then(data => {
                updateUsageDisplay(data);
                updateBlogUsageTable(data.blogs);
            })
            .catch(error => {
                console.error('Error fetching global usage:', error);
            });
    }
    
    function updateUsageDisplay(data) {
        // Update OpenAI usage
        const openAiUsage = data.openai || {};
        const openAiPercentage = Math.min(100, Math.round((openAiUsage.tokens_used || 0) / (openAiUsage.tokens_limit || 1) * 100));
        document.getElementById('openai-usage-bar').style.width = openAiPercentage + '%';
        document.getElementById('openai-usage-text').textContent = `${openAiUsage.tokens_used || 0} / ${openAiUsage.tokens_limit || 0} tokens`;
        document.getElementById('openai-credits').textContent = `$${(openAiUsage.cost || 0).toFixed(2)}`;
        
        // Update Image usage
        const imageUsage = data.image_generation || {};
        const imagePercentage = Math.min(100, Math.round((imageUsage.images_generated || 0) / (imageUsage.images_limit || 1) * 100));
        document.getElementById('image-usage-bar').style.width = imagePercentage + '%';
        document.getElementById('image-usage-text').textContent = `${imageUsage.images_generated || 0} / ${imageUsage.images_limit || 0} images`;
        document.getElementById('image-credits').textContent = `$${(imageUsage.cost || 0).toFixed(2)}`;
        
        // Update WordPress usage
        const wordpressUsage = data.wordpress || {};
        const wordpressPercentage = Math.min(100, Math.round((wordpressUsage.requests_made || 0) / (wordpressUsage.requests_limit || 1) * 100));
        document.getElementById('wordpress-usage-bar').style.width = wordpressPercentage + '%';
        document.getElementById('wordpress-usage-text').textContent = `${wordpressUsage.requests_made || 0} / ${wordpressUsage.requests_limit || 0} requests`;
        document.getElementById('wordpress-credits').textContent = `$${(wordpressUsage.cost || 0).toFixed(2)}`;
        
        // Update statistics
        document.getElementById('total-blogs').textContent = data.total_blogs || 0;
        document.getElementById('total-content').textContent = data.total_content || 0;
        document.getElementById('total-images').textContent = data.total_images || 0;
        document.getElementById('total-published').textContent = data.total_published || 0;
    }
    
    function updateBlogUsageTable(blogs) {
        const tbody = document.getElementById('blog-usage-tbody');
        tbody.innerHTML = '';
        
        if (!blogs || blogs.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="7" class="text-center">No blogs configured yet</td>';
            tbody.appendChild(row);
            return;
        }
        
        blogs.forEach(blog => {
            const row = document.createElement('tr');
            
            const lastGenerated = blog.last_generated 
                ? new Date(blog.last_generated).toLocaleDateString() 
                : 'Never';
                
            row.innerHTML = `
                <td><a href="/blog/${blog.id}">${blog.name}</a></td>
                <td>${blog.theme}</td>
                <td>${blog.content_count || 0}</td>
                <td>${blog.images_count || 0}</td>
                <td>${blog.published_count || 0}</td>
                <td>${lastGenerated}</td>
                <td>$${(blog.total_cost || 0).toFixed(2)}</td>
            `;
            
            tbody.appendChild(row);
        });
    }
</script>
{% endblock %}